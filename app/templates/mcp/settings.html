{% extends "base.html" %}

{% block title %}MCP Settings - Kanban Board{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold mb-4">MCP Settings</h1>
    
    <div class="flex justify-between items-center mb-6">
        <p class="text-gray-600">Configure integration with Cursor's MCP protocol</p>
    </div>
    
    <!-- Error message display -->
    <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>
    
    <!-- Success message display -->
    <div id="success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 hidden"></div>
    
    <!-- Settings form -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <form id="mcp-settings-form">
            <div class="mb-4">
                <div class="flex items-center mb-4">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="mcp-enabled" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 text-lg font-semibold text-gray-700">Enable MCP Integration</span>
                    </label>
                </div>
                
                <div id="mcp-settings-container" class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <div class="mb-4">
                        <label for="endpoint-url" class="block text-gray-700 mb-2">MCP Endpoint URL</label>
                        <input type="text" id="endpoint-url" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="http://localhost:5000/mcp">
                        <p class="text-sm text-gray-500 mt-1">This is the URL that Cursor will use to communicate with your Kanban board</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="api-key" class="block text-gray-700 mb-2">API Key (Optional)</label>
                        <input type="text" id="api-key" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Your API key">
                        <p class="text-sm text-gray-500 mt-1">If you want to secure the MCP endpoint with a key</p>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button type="submit" id="save-settings-btn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    Save Settings
                </button>
            </div>
        </form>
    </div>
    
    <!-- Cursor Integration Instructions -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4">How to Integrate with Cursor</h2>
        
        <div class="mb-6">
            <h3 class="font-semibold text-gray-700 mb-2">1. Enable MCP Integration</h3>
            <p class="text-gray-600">Enable the MCP integration above and set up your endpoint URL.</p>
        </div>
        
        <div class="mb-6">
            <h3 class="font-semibold text-gray-700 mb-2">2. Configure Cursor</h3>
            <p class="text-gray-600 mb-2">In Cursor, go to Settings â†’ MCP and add a new MCP server with your endpoint URL:</p>
            <div class="bg-gray-50 p-3 rounded border border-gray-200 font-mono text-sm overflow-x-auto">
                <code id="mcp-url-code">http://localhost:5000/mcp</code>
                <button id="copy-url-btn" class="ml-2 text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="font-semibold text-gray-700 mb-2">3. Test the Connection</h3>
            <p class="text-gray-600">Make sure your Kanban board is running, then test the connection in Cursor.</p>
        </div>
        
        <div>
            <h3 class="font-semibold text-gray-700 mb-2">4. Start Using Yolo Mode</h3>
            <p class="text-gray-600">When using Cursor in Yolo mode, it will automatically create and update tickets in your Kanban board.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const mcpEnabledCheckbox = document.getElementById('mcp-enabled');
        const settingsContainer = document.getElementById('mcp-settings-container');
        const endpointUrlInput = document.getElementById('endpoint-url');
        const apiKeyInput = document.getElementById('api-key');
        const mcpSettingsForm = document.getElementById('mcp-settings-form');
        const mcpUrlCode = document.getElementById('mcp-url-code');
        const copyUrlBtn = document.getElementById('copy-url-btn');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        
        // Initially fetch and set the current settings
        loadSettings();
        
        // Add event listeners
        mcpEnabledCheckbox.addEventListener('change', toggleSettingsVisibility);
        mcpSettingsForm.addEventListener('submit', saveSettings);
        copyUrlBtn.addEventListener('click', copyUrlToClipboard);
        
        // Functions
        function loadSettings() {
            fetchJSON('/mcp/config')
                .then(config => {
                    mcpEnabledCheckbox.checked = config.enabled;
                    endpointUrlInput.value = config.endpoint_url || '';
                    apiKeyInput.value = config.api_key || '';
                    
                    // Update the sample URL code
                    mcpUrlCode.textContent = config.endpoint_url || window.location.origin + '/mcp';
                    
                    // Set visibility of settings container
                    toggleSettingsVisibility();
                })
                .catch(error => {
                    showError('Failed to load MCP settings: ' + error.message);
                });
        }
        
        function toggleSettingsVisibility() {
            if (mcpEnabledCheckbox.checked) {
                settingsContainer.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                settingsContainer.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        
        function saveSettings(e) {
            e.preventDefault();
            
            // Hide any previous messages
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            
            const settings = {
                enabled: mcpEnabledCheckbox.checked,
                endpoint_url: endpointUrlInput.value,
                api_key: apiKeyInput.value
            };
            
            fetchJSON('/mcp/config', {
                method: 'POST',
                body: JSON.stringify(settings)
            })
                .then(response => {
                    // Update the sample URL code
                    mcpUrlCode.textContent = response.endpoint_url || window.location.origin + '/mcp';
                    
                    // Show success message
                    successMessage.textContent = 'MCP settings saved successfully';
                    successMessage.classList.remove('hidden');
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                    }, 3000);
                })
                .catch(error => {
                    showError('Failed to save MCP settings: ' + error.message);
                });
        }
        
        function copyUrlToClipboard() {
            const url = mcpUrlCode.textContent;
            
            navigator.clipboard.writeText(url)
                .then(() => {
                    // Show temporary success message
                    successMessage.textContent = 'URL copied to clipboard';
                    successMessage.classList.remove('hidden');
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                    }, 3000);
                })
                .catch(error => {
                    showError('Failed to copy URL: ' + error.message);
                });
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            
            // Hide error message after 5 seconds
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
    });
</script>
{% endblock %} 