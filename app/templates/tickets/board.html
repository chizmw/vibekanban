{% extends "base.html" %}

{% block title %}Kanban Board - Tickets{% endblock %}

{% block styles %}
<style>
    .kanban-column {
        min-height: 600px;
    }
    
    .ticket-card {
        cursor: grab;
    }
    
    .ticket-card:active {
        cursor: grabbing;
    }
    
    .ticket-card.dragging {
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div id="project-header" class="mb-6">
    <div class="flex items-center justify-between mb-2">
        <h1 id="project-name" class="text-2xl font-bold">Loading project...</h1>
        <div class="flex space-x-2">
            <button id="new-ticket-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded" disabled>
                <i class="fas fa-plus mr-2"></i> New Ticket
            </button>
            <a href="{{ url_for('projects.dashboard') }}" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100">
                <i class="fas fa-arrow-left mr-2"></i> Back to Projects
            </a>
        </div>
    </div>
    <p id="project-description" class="text-gray-600">Loading project details...</p>
</div>

<!-- Error message display -->
<div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>

<!-- Project selection form (shown if no project_id in URL) -->
<div id="project-selection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
    <h2 class="text-lg font-bold mb-4">Select a Project</h2>
    <form id="project-select-form" class="flex items-end space-x-4">
        <div class="flex-grow">
            <label for="project-select" class="block text-gray-700 mb-2">Project</label>
            <select id="project-select" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Select a project</option>
                <!-- Projects will be loaded here -->
            </select>
        </div>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            Load Board
        </button>
    </form>
</div>

<!-- Kanban board -->
<div id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <!-- Columns will be generated dynamically -->
    <div class="animate-pulse bg-gray-100 rounded-lg p-4 kanban-column"></div>
    <div class="animate-pulse bg-gray-100 rounded-lg p-4 kanban-column"></div>
    <div class="animate-pulse bg-gray-100 rounded-lg p-4 kanban-column"></div>
</div>

<!-- Empty state -->
<div id="empty-state" class="hidden text-center py-12">
    <i class="fas fa-ticket-alt text-gray-400 text-5xl mb-4"></i>
    <p class="text-gray-500 text-xl mb-4">No tickets found</p>
    <p class="text-gray-400 mb-4">Create your first ticket to get started</p>
    <button id="empty-new-ticket-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">
        <i class="fas fa-plus mr-2"></i> Create Ticket
    </button>
</div>

<!-- Ticket Modal -->
<div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold">New Ticket</h2>
            <button class="modal-close text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="ticket-form">
            <input type="hidden" id="ticket-id" value="">
            <input type="hidden" id="ticket-project-id" value="">
            
            <div class="mb-4">
                <label for="ticket-type" class="block text-gray-700 mb-2">Type</label>
                <select id="ticket-type" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <!-- Ticket types will be loaded here -->
                    <option value="">Loading types...</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="ticket-what" class="block text-gray-700 mb-2">What</label>
                <textarea id="ticket-what" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2" required></textarea>
            </div>
            
            <div class="mb-4">
                <label for="ticket-why" class="block text-gray-700 mb-2">Why</label>
                <textarea id="ticket-why" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
            </div>
            
            <div class="mb-6">
                <label for="ticket-acceptance" class="block text-gray-700 mb-2">Acceptance Criteria</label>
                <textarea id="ticket-acceptance" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
            </div>
            
            <div class="mb-4" id="ticket-state-container">
                <label for="ticket-state" class="block text-gray-700 mb-2">State</label>
                <select id="ticket-state" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <!-- Ticket states will be loaded here -->
                    <option value="">Loading states...</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" class="modal-close px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100">
                    Cancel
                </button>
                <button type="submit" id="save-ticket-btn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    Save Ticket
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
        <div class="mb-4">
            <h2 class="text-xl font-bold">Confirm Delete</h2>
            <p class="text-gray-600 mt-2">Are you sure you want to delete this ticket?</p>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button type="button" class="delete-modal-close px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100">
                Cancel
            </button>
            <button type="button" id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                Delete Ticket
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const projectHeader = document.getElementById('project-header');
        const projectName = document.getElementById('project-name');
        const projectDescription = document.getElementById('project-description');
        const projectSelection = document.getElementById('project-selection');
        const projectSelect = document.getElementById('project-select');
        const projectSelectForm = document.getElementById('project-select-form');
        const kanbanBoard = document.getElementById('kanban-board');
        const emptyState = document.getElementById('empty-state');
        const newTicketBtn = document.getElementById('new-ticket-btn');
        const emptyNewTicketBtn = document.getElementById('empty-new-ticket-btn');
        const ticketModal = document.getElementById('ticket-modal');
        const modalTitle = document.getElementById('modal-title');
        const ticketForm = document.getElementById('ticket-form');
        const ticketId = document.getElementById('ticket-id');
        const ticketProjectId = document.getElementById('ticket-project-id');
        const ticketType = document.getElementById('ticket-type');
        const ticketWhat = document.getElementById('ticket-what');
        const ticketWhy = document.getElementById('ticket-why');
        const ticketAcceptance = document.getElementById('ticket-acceptance');
        const ticketState = document.getElementById('ticket-state');
        const ticketStateContainer = document.getElementById('ticket-state-container');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        // State
        let currentProjectId = null;
        let ticketStates = [];
        let ticketTypes = [];
        let draggedTicket = null;
        
        // Get project_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectIdParam = urlParams.get('project_id');
        
        // Add event listeners
        newTicketBtn.addEventListener('click', () => openTicketModal());
        emptyNewTicketBtn.addEventListener('click', () => openTicketModal());
        
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => closeTicketModal());
        });
        
        document.querySelectorAll('.delete-modal-close').forEach(btn => {
            btn.addEventListener('click', () => closeDeleteModal());
        });
        
        ticketForm.addEventListener('submit', handleTicketSubmit);
        projectSelectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedProjectId = projectSelect.value;
            if (selectedProjectId) {
                window.location.href = `/tickets/board?project_id=${selectedProjectId}`;
            }
        });
        
        // Initialize
        Promise.all([
            loadTicketTypes(),
            loadTicketStates()
        ]).then(() => {
            if (projectIdParam) {
                currentProjectId = parseInt(projectIdParam);
                loadProject(currentProjectId);
                loadTickets(currentProjectId);
                newTicketBtn.disabled = false;
            } else {
                projectHeader.classList.add('hidden');
                projectSelection.classList.remove('hidden');
                loadProjects();
            }
        });
        
        // Functions
        function loadProject(projectId) {
            fetchJSON(`/projects/${projectId}`)
                .then(project => {
                    projectName.textContent = project.name;
                    projectDescription.textContent = project.description || 'No description provided';
                    ticketProjectId.value = project.id;
                })
                .catch(error => {
                    showError('Failed to load project: ' + error.message);
                });
        }
        
        function loadProjects() {
            fetchJSON('/projects/')
                .then(projects => {
                    projectSelect.innerHTML = '<option value="">Select a project</option>';
                    
                    if (projects && projects.length > 0) {
                        projects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.id;
                            option.textContent = project.name;
                            projectSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'No projects available';
                        projectSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    showError('Failed to load projects: ' + error.message);
                });
        }
        
        function loadTicketTypes() {
            return fetchJSON('/tickets/types')
                .then(types => {
                    ticketTypes = types;
                    ticketType.innerHTML = '';
                    
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.name;
                        ticketType.appendChild(option);
                    });
                })
                .catch(error => {
                    showError('Failed to load ticket types: ' + error.message);
                });
        }
        
        function loadTicketStates() {
            return fetchJSON('/tickets/states')
                .then(states => {
                    ticketStates = states;
                    ticketState.innerHTML = '';
                    
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.id;
                        option.textContent = state.name;
                        ticketState.appendChild(option);
                    });
                    
                    // Create Kanban board columns
                    renderKanbanColumns(states);
                })
                .catch(error => {
                    showError('Failed to load ticket states: ' + error.message);
                });
        }
        
        function renderKanbanColumns(states) {
            kanbanBoard.innerHTML = '';
            
            states.forEach(state => {
                const column = document.createElement('div');
                column.className = 'bg-gray-100 rounded-lg p-4 kanban-column';
                column.dataset.stateId = state.id;
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-4 pb-2 border-b border-gray-300';
                
                const title = document.createElement('h3');
                title.className = 'font-bold text-lg capitalize';
                title.textContent = state.name;
                
                const counter = document.createElement('span');
                counter.className = 'text-gray-500 text-sm bg-white px-2 py-1 rounded-full';
                counter.textContent = '0';
                counter.id = `counter-${state.id}`;
                
                header.appendChild(title);
                header.appendChild(counter);
                
                const ticketsContainer = document.createElement('div');
                ticketsContainer.className = 'tickets-container space-y-2';
                ticketsContainer.dataset.stateId = state.id;
                
                // Set up drop zone for drag and drop
                ticketsContainer.addEventListener('dragover', handleDragOver);
                ticketsContainer.addEventListener('drop', handleDrop);
                
                column.appendChild(header);
                column.appendChild(ticketsContainer);
                
                kanbanBoard.appendChild(column);
            });
        }
        
        function loadTickets(projectId) {
            fetchJSON(`/tickets/?project_id=${projectId}`)
                .then(tickets => {
                    // Clear all ticket containers
                    document.querySelectorAll('.tickets-container').forEach(container => {
                        container.innerHTML = '';
                    });
                    
                    if (tickets && tickets.length > 0) {
                        kanbanBoard.classList.remove('hidden');
                        emptyState.classList.add('hidden');
                        
                        // Group tickets by state
                        const ticketsByState = {};
                        tickets.forEach(ticket => {
                            if (!ticketsByState[ticket.state]) {
                                ticketsByState[ticket.state] = [];
                            }
                            ticketsByState[ticket.state].push(ticket);
                        });
                        
                        // Add tickets to their respective columns
                        ticketStates.forEach(state => {
                            const container = document.querySelector(`.tickets-container[data-state-id="${state.id}"]`);
                            const counter = document.getElementById(`counter-${state.id}`);
                            
                            if (container) {
                                const stateTickets = ticketsByState[state.id] || [];
                                counter.textContent = stateTickets.length;
                                
                                stateTickets.forEach(ticket => {
                                    container.appendChild(createTicketCard(ticket));
                                });
                            }
                        });
                    } else {
                        kanbanBoard.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    showError('Failed to load tickets: ' + error.message);
                });
        }
        
        function createTicketCard(ticket) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-4 ticket-card';
            card.dataset.id = ticket.id;
            card.draggable = true;
            
            // Set up drag events
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-start mb-2';
            
            const type = document.createElement('span');
            const typeName = ticket.type_name || getTypeNameById(ticket.type);
            type.className = `px-2 py-1 rounded text-xs font-semibold ${getTypeClass(typeName)}`;
            type.textContent = typeName;
            
            const actions = document.createElement('div');
            actions.className = 'flex space-x-1';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'text-gray-500 hover:text-gray-700';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openTicketModal(ticket);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-gray-500 hover:text-red-700';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openDeleteModal(ticket.id);
            });
            
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            
            header.appendChild(type);
            header.appendChild(actions);
            
            const what = document.createElement('p');
            what.className = 'font-semibold mb-2';
            what.textContent = ticket.what;
            
            let additionalInfo = '';
            if (ticket.why) {
                additionalInfo += `<div class="mb-1"><span class="font-semibold text-gray-600">Why:</span> ${ticket.why}</div>`;
            }
            
            if (ticket.acceptance_criteria) {
                additionalInfo += `<div><span class="font-semibold text-gray-600">Acceptance:</span> ${ticket.acceptance_criteria}</div>`;
            }
            
            const details = document.createElement('div');
            details.className = 'text-sm text-gray-600 overflow-hidden';
            details.innerHTML = additionalInfo;
            
            const dates = document.createElement('div');
            dates.className = 'text-xs text-gray-500 mt-3 flex justify-between';
            dates.innerHTML = `<span>Created: ${new Date(ticket.created_date).toLocaleDateString()}</span>`;
            
            if (ticket.completed_date) {
                dates.innerHTML += `<span>Completed: ${new Date(ticket.completed_date).toLocaleDateString()}</span>`;
            }
            
            card.appendChild(header);
            card.appendChild(what);
            
            if (additionalInfo) {
                card.appendChild(details);
            }
            
            card.appendChild(dates);
            
            return card;
        }
        
        function getTypeNameById(typeId) {
            const type = ticketTypes.find(t => t.id === typeId);
            return type ? type.name : 'unknown';
        }
        
        function getTypeClass(typeName) {
            switch (typeName.toLowerCase()) {
                case 'bug':
                    return 'bg-red-100 text-red-800';
                case 'story':
                    return 'bg-green-100 text-green-800';
                case 'spike':
                    return 'bg-purple-100 text-purple-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
        
        function openTicketModal(ticket = null) {
            ticketForm.reset();
            
            if (ticket) {
                modalTitle.textContent = 'Edit Ticket';
                ticketId.value = ticket.id;
                ticketProjectId.value = ticket.project_id;
                ticketType.value = ticket.type;
                ticketWhat.value = ticket.what;
                ticketWhy.value = ticket.why || '';
                ticketAcceptance.value = ticket.acceptance_criteria || '';
                ticketState.value = ticket.state;
                ticketStateContainer.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'New Ticket';
                ticketId.value = '';
                ticketProjectId.value = currentProjectId;
                
                // Get the backlog state for new tickets
                const backlogState = ticketStates.find(state => state.name.toLowerCase() === 'backlog');
                if (backlogState) {
                    ticketState.value = backlogState.id;
                }
                
                // Hide state selection for new tickets (always start in backlog)
                ticketStateContainer.classList.add('hidden');
            }
            
            ticketModal.classList.remove('hidden');
        }
        
        function closeTicketModal() {
            ticketModal.classList.add('hidden');
        }
        
        function openDeleteModal(ticketId) {
            confirmDeleteBtn.dataset.id = ticketId;
            deleteModal.classList.remove('hidden');
            
            confirmDeleteBtn.addEventListener('click', handleTicketDelete);
        }
        
        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            confirmDeleteBtn.removeEventListener('click', handleTicketDelete);
        }
        
        function handleTicketSubmit(e) {
            e.preventDefault();
            
            const id = ticketId.value;
            const ticketData = {
                project_id: parseInt(ticketProjectId.value),
                type: parseInt(ticketType.value),
                what: ticketWhat.value,
                why: ticketWhy.value,
                acceptance_criteria: ticketAcceptance.value,
                state: parseInt(ticketState.value)
            };
            
            let url = '/tickets/';
            let method = 'POST';
            
            if (id) {
                url = `/tickets/${id}`;
                method = 'PUT';
            }
            
            fetchJSON(url, {
                method,
                body: JSON.stringify(ticketData)
            })
                .then(() => {
                    closeTicketModal();
                    loadTickets(currentProjectId);
                })
                .catch(error => {
                    showError('Failed to save ticket: ' + error.message);
                });
        }
        
        function handleTicketDelete() {
            const ticketId = confirmDeleteBtn.dataset.id;
            
            fetchJSON(`/tickets/${ticketId}`, {
                method: 'DELETE'
            })
                .then(() => {
                    closeDeleteModal();
                    loadTickets(currentProjectId);
                })
                .catch(error => {
                    showError('Failed to delete ticket: ' + error.message);
                });
        }
        
        // Drag and Drop functionality
        function handleDragStart(e) {
            draggedTicket = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }
        
        function handleDragEnd() {
            this.classList.remove('dragging');
            draggedTicket = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e) {
            e.preventDefault();
            if (!draggedTicket) return;
            
            const ticketId = parseInt(draggedTicket.dataset.id);
            const newStateId = parseInt(this.dataset.stateId);
            
            // Update the ticket state
            fetchJSON(`/tickets/${ticketId}`, {
                method: 'PUT',
                body: JSON.stringify({ state: newStateId })
            })
                .then(() => {
                    loadTickets(currentProjectId);
                })
                .catch(error => {
                    showError('Failed to update ticket state: ' + error.message);
                });
            
            return false;
        }
    });
</script>
{% endblock %} 